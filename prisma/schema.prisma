datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id           String       @id @default(cuid())
  email        String       @unique
  passwordHash String? // bcrypt hash
  name         String?
  provider     AuthProvider @default(EMAIL)
  providerId   String?
  plan         Plan         @default(FREE)
  credits      Int          @default(3)
  avatar       String?

  // Notifications bell: last time the user opened/"saw" notifications.
  // Use this to compute badge/new count: Notification.createdAt > notificationsLastSeenAt
  notificationsLastSeenAt DateTime?

  generations    SvgGeneration[]
  refreshTokens  RefreshToken[]
  generationJobs GenerationJob[]
  notifications  Notification[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  resetPasswordToken   String? // hashed token
  resetPasswordExpires DateTime?

  termsAcceptedAt DateTime?
  termsAcceptedIp String?

  @@unique([provider, providerId])
  @@index([email])
}

model SvgGeneration {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id])
  userId String

  prompt      String
  svg         String // the actual SVG code
  style       String? // 'outline', 'duotone', etc.
  model       String? @default("gpt-4o")
  creditsUsed Int? // optional
  privacy     Boolean @default(false)

  s3Key String? @unique
  s3SizeBytes Int?

  createdAt DateTime @default(now())

  generationJob GenerationJob? @relation("JobToGeneration")

  @@index([userId, createdAt])
}

model RefreshToken {
  id String @id @default(cuid())

  // hashed token secret (never store plain token)
  token String @unique

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Group tokens that belong to the same login/session chain.
  // When you detect reuse, revoke the entire family.
  familyId String @default(cuid())

  // Rotation / revocation tracking
  createdAt  DateTime  @default(now())
  expiresAt  DateTime
  lastUsedAt DateTime?

  revokedAt DateTime?

  replacedByTokenId String?       @unique
  replacedByToken   RefreshToken? @relation("TokenReplacement", fields: [replacedByTokenId], references: [id])
  replacesToken     RefreshToken? @relation("TokenReplacement")

  // Optional metadata
  ipAddress String?
  userAgent String?

  @@index([userId])
  @@index([familyId])
  @@index([revokedAt])
}

model GenerationJob {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  prompt String
  style  String?
  model  String  @default("gpt-4o")
  privacy Boolean @default(false)

  status GenerationJobStatus @default(QUEUED)

  createdAt     DateTime  @default(now())
  startedAt     DateTime?
  lastStartedAt DateTime?
  finishedAt    DateTime?

  errorCode       String?
  errorMessage    String?
  creditsCharged  Boolean   @default(false)
  creditsRefunded Boolean   @default(false)
  attemptsMade    Int       @default(0)
  lastFailedAt    DateTime?

  // Idempotency: optional header from client to prevent double submits
  idempotencyKey String?
  requestHash    String? // Hash of request params to detect key reuse with different params

  generationId String?        @unique
  generation   SvgGeneration? @relation("JobToGeneration", fields: [generationId], references: [id])

  @@unique([userId, idempotencyKey])
  @@index([userId, createdAt])
  @@index([status, createdAt])
  @@index([userId, status])
}

model Notification {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type NotificationType

  title   String?
  message String

  data Json?

  jobId String?

  createdAt DateTime  @default(now())
  readAt    DateTime?
  expiresAt DateTime?

  @@unique([userId, jobId, type])
  @@index([userId, createdAt])
  @@index([userId, readAt])
}

enum Plan {
  FREE
  CUSTOMER
  UNLIMITED
}

enum AuthProvider {
  EMAIL // Traditional email/password
  GOOGLE // Google OAuth
  GITHUB // GitHub OAuth
}

enum GenerationJobStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  FAILED
}

enum NotificationType {
  JOB_SUCCEEDED
  JOB_FAILED
  LOW_CREDITS
  PROMO_MONTHLY
  CREDITS_PURCHASED
  CREDITS_REFUNDED
  ACCOUNT_SECURITY
  SYSTEM_ANNOUNCEMENT
}
