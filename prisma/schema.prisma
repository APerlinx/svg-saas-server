datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id           String          @id @default(cuid())
  email        String          @unique
  passwordHash String?          // bcrypt hash
  name         String?         
  provider     AuthProvider    @default(EMAIL)
  providerId   String?         @unique
  plan         Plan            @default(FREE)
  credits      Int             @default(3)
  avatar                String? 

  generations  SvgGeneration[]
  refreshTokens RefreshToken[]
  
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  resetPasswordToken   String?   // hashed token
  resetPasswordExpires DateTime?

  termsAcceptedAt   DateTime? 
  termsAcceptedIp   String?

  @@index([email])
  @@index([providerId])
}

model SvgGeneration {
  id         String   @id @default(cuid())
  user       User     @relation(fields: [userId], references: [id])
  userId     String

  prompt     String
  svg        String   // the actual SVG code
  style      String?  // 'outline', 'duotone', etc.
  model      String?  @default("gpt-5-mini")
  creditsUsed  Int?     // optional
  privacy    Boolean  @default(false)
  
  createdAt  DateTime @default(now())

  @@index([userId, createdAt])
}

model RefreshToken {
  id        String   @id @default(cuid())

  // hashed token secret (never store plain token)
  token     String   @unique

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Group tokens that belong to the same login/session chain.
  // When you detect reuse, revoke the entire family.
  familyId  String   @default(cuid())

  // Rotation / revocation tracking
  createdAt DateTime @default(now())
  expiresAt DateTime
  lastUsedAt DateTime?

  revokedAt DateTime?
  
  replacedByTokenId String? @unique
  replacedByToken   RefreshToken? @relation("TokenReplacement", fields: [replacedByTokenId], references: [id])
  replacesToken     RefreshToken? @relation("TokenReplacement")

  // Optional metadata
  ipAddress String?
  userAgent String?

  @@index([userId])
  @@index([familyId])
  @@index([revokedAt])
}


enum Plan {
  FREE
  CUSTOMER
  UNLIMITED
}

enum AuthProvider {
  EMAIL    // Traditional email/password
  GOOGLE   // Google OAuth
  GITHUB   // GitHub OAuth
}